# Development Guide

To develop the PostgreSQL connector locally, you will need:

- a GCP project
- the `PROJECT_ID` variable set to your project
- one GKE cluster (with at least 4 nodes, recommended machine type `n1-standard-4`)
- [skaffold](https://skaffold.dev/docs/install/) and [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) installed to your local environment

All commands needs to be executed inside `postgresql-connector` directory.

### Build images and deploy once

```
skaffold run --default-repo=gcr.io/${PROJECT_ID}/bank-of-anthos
```

### Build images and deploy continuously

Use `skaffold dev` to automatically propagate code changes to your cluster on file save.

```
skaffold dev --default-repo=gcr.io/${PROJECT_ID}/bank-of-anthos
```

### Adding Packages in the Python Services

The `requirements.txt` file is auto-generated by `pip-compile`, then used by the Dockerfile to install python packages in the container.
To add a package, first add the package name to `requirements.in` within the service (ex: frontend service).
Then run:

```
python3 -m pip install pip-tools
python3 -m piptools compile --output-file=requirements.txt requirements.in

# run skaffold or docker build using the generated requirements.txt
```

Alternatively, you can also run:

```
python3 -m venv .
source ./bin/activate
pip install pip-tools

pip-compile --output-file=requirements.txt requirements.in
```

# run skaffold or docker build using the generated requirements.txt

### Build and Run the Docker image locally
>`/system/data` should contain the credentials file.

>`/system/key` should contain the generated jwt key.

```
# build
docker build -t bank-of-anthos-postgresql-connector .
# run
docker run \
-v /system/data:/data \
-v /system/key:/key \
--env GOOGLE_APPLICATION_CREDENTIALS=/data/credentials.json \
--env PUB_KEY_PATH=/key/jwtRS256.key.pub \
--env DATACATALOG_PROJECT_ID=my-project \
--env DATACATALOG_LOCATION_ID=us-central1 \
--env POSTGRESQL_SERVER=104.154.57.237 \
--env POSTGRES_USER=user-test \
--env POSTGRES_PASSWORD=user-pass \
--env POSTGRES_DB=postgres \
--env VERSION=0.1.0 \
--env LOG_LEVEL=debug \
-p 8080:8080 \
bank-of-anthos-postgresql-connector
```

### Test commands

#### Get the connector version
```
kubectl exec $(kubectl get pod -l app=postgresql-connector -o jsonpath={.items..metadata.name}) -- curl http://postgresql-connector:8080/version
```

#### Call the connector manually
> `{TOKEN_PLACEHOLDER}` should be generated with the jwt key at `deployment.md`

```
kubectl exec $(kubectl get pod -l app=postgresql-connector -o jsonpath={.items..metadata.name}) -- curl \
-X POST \
  http://postgresql-connector:8080/sync \
  -H 'Accept: */*' \
  -H 'Accept-Encoding: gzip, deflate' \
  -H 'Authorization: Bearer {TOKEN_PLACEHOLDER}'
```